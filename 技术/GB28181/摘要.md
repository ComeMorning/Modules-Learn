## 术语

- SIP监控域SIP
  支持本标准规定
- 非SIP监控域
  不支持本标准规定

## 结构图

功能实体之间的通道互联协议分为**会话通道协议**、**媒体(本标准主要指视/音频)流通道协议**两种类型，会话通道协议见4.3.2~4. 3.4的规定，媒体流通道协议见4.3.5和4.3.6的规定。



![image-20210906101554360](https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/image-20210906101554360.png)

- 级联
  两个**信令安全路由网关之间**是上下级关系，下级信令安全路由网关主动向上级信令安全路由网关发起注册,经上级信令安全路由网关鉴权认证后才能进行系统间通信。

![image-20210906101621199](https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/image-20210906101621199.png)

- 互联

  平级关系

  ![image-20210906103822409](https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/image-20210906103822409.png)

## 通信协议概述

![通信协议结构图](https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/image-20210906145355098.png)

**会话通道**

- 会话初始协议 SIP， 涉及 REGISTER、INVITE、INFO、MESSAGE等方法
- 会话描述协议 SDP，会话描述、媒体信息描述、时间信息描述，附录F，**在SIP消息MESSAGE消息体中携带传输**
- 控制描述协议 **MANSCDP**，设备控制、报警信息、目录信息等控制，附录A，**在SIP消息MESSAGE消息体中携带传输**

**媒体通道**

- 媒体回放控制协议，采用监控报警联网系统实时流协议 MANSRTSP，附录B，**在SIP消息INFO消息体中携带传输**

- 媒体传输和编解码协议 RTP
  - PS封装，附录C
  - RTP+RTCP，RTP默认是UDP传输

## 数据交换

### 统一编码

- ID统一编码规则

  **应根据不同情况采用不同编码，对于非标准SIP设备,宜通过网关进行认证。**（8.1）

  - 20位规则A，附录D.1
  - 局部应用系统也可使用18位规则B，附录D.2

- SIP URI编码规则

  - 格式：**sip[s]:username@domain:port**
  - username 唯一，宜采用ID统一编码
  - domain宜采用ID统一编码的前十位
  - port: 建议5060

### 安全性要求

1. 身份认证（8.1）

   - 低安全级别：数字摘要认证（见9.1）
   - 高安全级别: 数字证书（见9.1）

2. 数据加密

   高安全级别：网络层采用IPSec或者在传输层采用TLS

3. **对SIP信令做数字摘要认证**

4. 数据完整性保护：Md5\SHA-1\SHA-256

5. 跨域访问 Monitor-User- Identity 请求头

##  控制过程和要求（主要编程部分）

第7章和第9章结合

所有示例：附录J

### 1. 注册

- 过程见 9.1

### 2. 实时音视频点播

- 多播
- 双向对讲
- 通过SDP协议
- 过程见 9.2

### 3. 设备控制

- 控制球机\云台\录像\布防\撤防\报警复位\远程启动
- XML格式，见附录A
- 过程见 9.3

### 4. 报警事件通知和分发

- XML格式，见附录A
- 过程见 9.4

### 5. 设备信息查询

- 支持分级查询
- 获取设备状态信息
- 获取设备目录信息
- XML格式，见附录A
- 过程见9.5.2

### 6. 状态信息报送

- 主动上报：网络内的监控设备、报警设备、相关服务器以及连接的安全防
  范视频监控联网系统的运行情况
- XML格式，见附录A
- 过程见9.6

### 7. 历史视音频文件检索

- 支持指定设备、指定时间范围查询
- 过程见9.7

### 8. 历史视音频回放

- 支持指定设备或系统、指定时间的历史视音频数据进行远程回放
- 支持正常播放、快速播放、慢速播放、画面暂停、随机拖放等媒体回放控制
- SDP 协议 +  MANS RTSP 格式
- 附录B
- 过程见9.8

### 9. 历史音视频文件下载

- 指定设备、指定时间段的历史音视频文件下载
- 过程见9.9

### 10. 网络校时

- SIP信令统一校时
- 注册时，接受来自SIP服务器通过消息头Date域授时

### 11. 订阅和通知

- 事件订阅
- 目录订阅
- 过程见 9.11

## 设备控制命令 - MANSCDP

**附录A部分**

> 学习： [DTD - 属性 (w3school.com.cn)](https://www.w3school.com.cn/dtd/dtd_attributes.asp)

### 1. Control 控制命令

- DeviceControl

  多选：控制球机\云台\录像\布防\撤防\报警复位\远程启动

### 2. Query 查询命令

- DeviceStatus - 查询设备状态
- Catalog - 设备目录查询

- DeviceInfo - 设备信息查询
- RecordInfo - 文件目录检索
- Alarm - 报警查询

### 3. Notify 通知命令

- Keepalive - 设备状态信息报送
- Alarm - 报警通知

### 4. Response 应答命令

应答命令与上面命令相对应

- DeviceControl - 设备控制应答
- DeviceStatus - 设备状态信息查询应答
- Catalog - 设备目录信息查询**收到**应答
- Catalog - 设备目录信息查询应答
- Catalog - 设备目录收到应答
- DeviceInfo - 设备信息查询应答
- RecordInfo - 文件目录检索应答
- Alarm - 报警通知应答

